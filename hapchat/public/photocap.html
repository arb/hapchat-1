<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>HapChat!</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/united/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#"><img src="/logo.png" height="24" /> Hapchat</a>
        </div>
        <div class="navbar-collapse collapse">
            <form class="navbar-form navbar-right" role="form">
                <div class="form-group">
                    <input type="text" placeholder="Email" class="form-control">
                </div>
                <div class="form-group">
                    <input type="password" placeholder="Password" class="form-control">
                </div>
                <button type="submit" class="btn btn-success">Sign in</button>
            </form>
        </div><!--/.navbar-collapse -->
    </div>
</div>

<div class="container">
    <!-- Example row of columns -->
    <div class="row">
        <div class="col-md-12">
            <h2>Take Photo</h2>
            <p>Take a photo using your web cam, right now! </p>
            <p><a id="showCameraBtn" class="btn btn-default" href="#" role="button" data-toggle="modal" data-target="#photoModal">Take Photo</a></p>
        </div>
    </div>

    <hr>

    <footer>
        <p>&copy; Company 2014</p>
    </footer>
</div> <!-- /container -->

<form>
    <div class="modal fade" id="photoModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title">Photo Taker</h4>
          </div>
          <div class="modal-body">
            <p>Say cheese&hellip;</p>
              <video autoplay id="cameraVideo" height="200" width="200"></video>
              <br />
              <canvas id="cameraCanvas" height="200" width="200"></canvas>
              <br />
              <img id="cameraImg" height="200" width="200" />
              <br />
              <button id="takePhotoBtn" type="button" class="btn btn-primary"></button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button id="uploadBtn" type="button" class="btn btn-primary">Upload</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
</form>

<script>
navigator.getUserMedia  = navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia;

window.addEventListener("load", function() {

    var interval = 33;
    var width = 200;
    var height = 200;

    var imageCapture = null;
    var localMediaStream = null;

    var video = $('#cameraVideo');
    var canvas = $('#cameraCanvas');
    var img = $('#cameraImg');
    var takePhotoBtn = $('#takePhotoBtn');
    var showCameraBtn = $('#showCameraBtn');
    var modal = $('#photoModal');
    var uploadBtn = $('#uploadBtn');

    video.hide();
    img.hide();

    var ctx = canvas[0].getContext('2d');

    if (navigator.getUserMedia) {

        var drawCanvas = function () {

            if (localMediaStream) {
                ctx.drawImage(video[0], 0, 0, 200, 200);
            }
        };

        var updateImg = function () {

            if (localMediaStream) {
                img.attr('src', canvas[0].toDataURL('image/webp'));
            }
        };

        var captureVideo = function () {

            if (!imageCapture) {
                var videoOptions = {
                    audio: false,
                    video: {
                        mandatory: {
                            minWidth: width,
                            minHeight: height,
                            maxWidth: width,
                            maxHeight: height
                        }
                    }
                };

                navigator.getUserMedia(videoOptions, function(stream) {

                    video.attr('src', window.URL.createObjectURL(stream));

                    localMediaStream = stream;
                    imageCapture = setInterval(drawCanvas, interval);

                    takePhotoBtn.unbind('click');
                    takePhotoBtn.on('click', takeSnapshot);
                    takePhotoBtn.text('Take photo');
                }, function (err) {


                  alert(err)
                });
            }
        };

        var stopCapture = function () {

            localMediaStream.stop();
            imageCapture = null;
        }

        var takeSnapshot = function () {

            clearInterval(imageCapture);
            imageCapture = null;

            takePhotoBtn.unbind('click');
            takePhotoBtn.on('click', captureVideo)
            takePhotoBtn.text('Take a different photo');
        }

        showCameraBtn.on('click', captureVideo);
        modal.on('hidden.bs.modal', stopCapture);

        var uploadImage = function () {

            var generateBoundary = function (length) {

                length = length || 8;
                var boundaryString = '';
                var chars = 'ABCDEFabcdef012345678'.split('');

                for (var i = 0, il = length; i < il; ++i) {
                    boundaryString += chars[Math.floor(chars.length * Math.random())];
                }

                return boundaryString;
            };

            var buildPayload = function () {

                var boundary = generateBoundary();
                var payload = 'pre\r\nemble\r\n' + '--' + boundary + '\r\n';

                payload += 'Content-Disposition: form-data; name="user"\r\n\r\n';
                payload += (new Date()).getTime() + '\r\n';

                payload += '--' + boundary + '\r\n';

                payload += 'Content-Disposition: form-data; name="image"\r\n\r\n';
                //payload += 'Content-Type: image/jpeg\nContent-Transfer-Encoding: binary\n\n';
                payload += canvas[0].toDataURL('image/jpeg') + '\r\n';

                payload += '--' + boundary + '--\r\n' + 'epi\r\nlogue';

                return {
                    boundary: boundary,
                    payload: payload
                };
            };

            var requestData = buildPayload();

            $.post('/upload', canvas[0].toDataURL('image/jpeg').split(',')[1]);

            /*$.ajax({
                type: 'POST',
                url: '/upload',
                //data: requestData.payload,
                //contentType: 'multipart/form-data; boundary=' + requestData.boundary,
                data: {
                    user: (new Date()).getTime(),
                    image: canvas[0].toDataURL('image/jpeg')
                },
                contentType: false,
                processData: false,
                cache: false//,
                //success,
                //failure
            }); */
        };

        uploadBtn.on('click', uploadImage);
    }
});
</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>
